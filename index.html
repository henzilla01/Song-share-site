<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🎵 Song Share</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>🎵 Song Share</h1>
</header>

<main>
  <!-- Search -->
  <section id="search-section">
    <input type="text" id="search-input" placeholder="Search songs...">
  </section>

  <!-- Song List -->
  <section id="song-list">
    <h2>All Songs</h2>
    <div id="songs-container"></div>
  </section>

  <!-- Top 10 -->
  <section id="top-10">
    <h2>🔥 Top 10 Songs</h2>
    <div id="top-songs-container"></div>
  </section>

  <!-- Admin Upload -->
  <section id="admin">
    <h2>Admin: Add Song</h2>
    <input type="text" id="song-title" placeholder="Song Title">
    <input type="text" id="song-url" placeholder="Cloudflare R2 MP3 URL">
    <input type="text" id="cover-url" placeholder="Cloudflare R2 Cover URL">
    <button id="add-song-btn">Add Song</button>
    <p id="admin-status"></p>
  </section>
</main>

<!-- Firebase & App Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyAeOEO_5kOqqQU845sSKOsaeJzFmk",
    authDomain: "joinhugparty.firebaseapp.com",
    projectId: "joinhugparty",
    storageBucket: "joinhugparty.firebasestorage.app",
    messagingSenderId: "540501854830",
    appId: "1:540501854830:web:7249bb97b50582fe97747f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== DOM Elements =====
  const songsContainer = document.getElementById("songs-container");
  const topSongsContainer = document.getElementById("top-songs-container");
  const searchInput = document.getElementById("search-input");
  const addBtn = document.getElementById("add-song-btn");
  const statusText = document.getElementById("admin-status");

  // ===== Add Song (Admin) =====
  addBtn.addEventListener("click", async () => {
    const title = document.getElementById("song-title").value;
    const songURL = document.getElementById("song-url").value;
    const coverURL = document.getElementById("cover-url").value;

    if(!title || !songURL || !coverURL) { alert("Fill all fields!"); return; }

    try {
      await addDoc(collection(db, "songs"), {
        title,
        songURL,
        coverURL,
        likes: 0,
        stars: 0,
        votes: 0,
        createdAt: serverTimestamp()
      });
      statusText.textContent = "Song added!";
      loadSongs();
    } catch (err) {
      console.error("Error adding song:", err);
    }
  });

  // ===== Load Songs =====
  async function loadSongs() {
    songsContainer.innerHTML = "";
    topSongsContainer.innerHTML = "";

    const q = query(collection(db, "songs"), orderBy("createdAt", "desc"));
    const snapshot = await getDocs(q);
    const songs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    const search = searchInput.value.toLowerCase();
    const filtered = songs.filter(s => s.title.toLowerCase().includes(search));

    // Display All Songs
    filtered.forEach(song => {
      const card = document.createElement("div");
      card.className = "song-card";
      card.innerHTML = `
        <img src="${song.coverURL}" alt="${song.title}">
        <div class="info">
          <h3>${song.title}</h3>
          <audio controls src="${song.songURL}"></audio>
          <div class="star-rating" id="stars-${song.id}"></div>
          <div class="buttons">
            <button id="like-btn-${song.id}">❤️ Like (${song.likes})</button>
            <button id="whatsapp-btn-${song.id}">Send to WhatsApp</button>
          </div>
        </div>
      `;
      songsContainer.appendChild(card);

      renderStars(song);

      document.getElementById(`like-btn-${song.id}`).addEventListener("click", async () => {
        const songRef = doc(db, "songs", song.id);
        await updateDoc(songRef, { likes: (song.likes || 0) + 1 });
        loadSongs();
      });

      document.getElementById(`whatsapp-btn-${song.id}`).addEventListener("click", () => {
        const msg = prompt("Enter your message:");
        if(!msg) return;
        const text = encodeURIComponent(msg + "\nListen: " + song.songURL);
        window.open(`https://wa.me/YOUR_PHONE_NUMBER?text=${text}`, "_blank");
      });
    });

    // Top 10
    const topSongs = [...songs].sort((a,b) => (b.likes||0) - (a.likes||0)).slice(0,10);
    topSongs.forEach(song => {
      const card = document.createElement("div");
      card.className = "song-card";
      card.innerHTML = `<img src="${song.coverURL}" alt="${song.title}"><h3>${song.title} ❤️ ${song.likes} ⭐ ${song.votes ? (song.stars/song.votes).toFixed(1) : 0}</h3>`;
      topSongsContainer.appendChild(card);
    });
  }

  loadSongs();
  searchInput.addEventListener("input", loadSongs);

  function renderStars(song) {
    const container = document.getElementById(`stars-${song.id}`);
    container.innerHTML = "";
    const avg = song.votes ? song.stars/song.votes : 0;
    for(let i=1; i<=5; i++) {
      const star = document.createElement("span");
      star.className = "star" + (i <= avg ? " filled" : "");
      star.innerHTML = "★";
      star.addEventListener("click", async () => {
        const songRef = doc(db, "songs", song.id);
        await updateDoc(songRef, { stars: (song.stars||0)+i, votes: (song.votes||0)+1 });
        loadSongs();
      });
      container.appendChild(star);
    }
  }
</script>
